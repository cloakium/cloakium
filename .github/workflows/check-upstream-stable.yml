name: Check upstream Chrome Stable (CfT)

on:
  schedule:
    - cron: "23 */3 * * *"
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch latest upstream Stable version (CfT last-known-good)
        id: upstream
        run: |
          set -euo pipefail
          v="$(curl -fsSL \
            "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json" \
            | jq -r '.channels.Stable.version')"
          echo "version=$v" >> "$GITHUB_OUTPUT"
          echo "Upstream Stable: $v"

      - name: Compute compound tag for current patches
        id: tag
        run: |
          set -euo pipefail
          v="${{ steps.upstream.outputs.version }}"
          short="$(git rev-parse --short HEAD)"
          tag="${v}+cloakium-${short}"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "Compound tag: $tag"

      - name: Check if release already exists for this tag
        id: last
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          tag="${{ steps.tag.outputs.tag }}"
          if gh release view "$tag" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release $tag already exists"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No release for $tag"
          fi

      - name: Dispatch build if no release exists
        if: steps.last.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          v="${{ steps.upstream.outputs.version }}"
          tag="${{ steps.tag.outputs.tag }}"
          echo "No release for $tag â€” dispatching build"
          gh workflow run build-and-release.yml \
            --repo "$GITHUB_REPOSITORY" \
            -f upstream_version="$v"
