name: Stealth Tests

on:
  workflow_run:
    workflows: ["Build + Release"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: |
          pip install pytest pytest-timeout playwright
          playwright install chromium
          playwright install-deps

      - name: Download Cloakium binary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python3 scripts/download.py --dest ./cloakium-bin
          echo "STEALTH_BINARY=$(tail -1 <<< "$(python3 scripts/download.py --dest ./cloakium-bin 2>&1)")" >> "$GITHUB_ENV"

      - name: Resolve binary path
        run: |
          # find the chrome binary in cloakium-bin/
          BINARY="$(find ./cloakium-bin -name chrome -type f | head -1)"
          if [ -z "$BINARY" ]; then
            echo "::error::Chrome binary not found in cloakium-bin/"
            exit 1
          fi
          chmod +x "$BINARY"
          echo "STEALTH_BINARY=$BINARY" >> "$GITHUB_ENV"
          echo "Binary: $BINARY"

      - name: Run stealth tests
        env:
          STEALTH_BINARY: ${{ env.STEALTH_BINARY }}
        run: |
          mkdir -p reports
          pytest tests/test_stealth.py::TestWebDriverDetection \
            -v --tb=short \
            --junitxml=reports/results.xml \
            2>&1 | tee reports/test-output.txt || true

      - name: Generate report
        if: always()
        run: |
          python3 - <<'PYEOF'
          import xml.etree.ElementTree as ET
          import datetime, os

          xml_path = "reports/results.xml"
          md_path = "reports/stealth-test-latest.md"

          if not os.path.exists(xml_path):
              with open(md_path, "w") as f:
                  f.write("# Stealth Test Report\n\nNo test results found.\n")
              raise SystemExit(0)

          tree = ET.parse(xml_path)
          root = tree.getroot()
          suite = root.find("testsuite") if root.tag != "testsuite" else root

          tests = int(suite.get("tests", 0))
          failures = int(suite.get("failures", 0))
          errors = int(suite.get("errors", 0))
          skipped = int(suite.get("skipped", 0))
          passed = tests - failures - errors - skipped
          timestamp = datetime.datetime.now(datetime.timezone.utc).strftime("%Y-%m-%d %H:%M UTC")

          lines = [
              "# Stealth Test Report",
              "",
              f"**Date:** {timestamp}",
              f"**Result:** {passed}/{tests} passed",
              "",
              "| Test | Status |",
              "|------|--------|",
          ]

          for tc in suite.iter("testcase"):
              name = tc.get("name", "unknown")
              failure = tc.find("failure")
              error = tc.find("error")
              skip = tc.find("skipped")
              if failure is not None:
                  status = "FAIL"
              elif error is not None:
                  status = "ERROR"
              elif skip is not None:
                  status = "SKIP"
              else:
                  status = "PASS"
              lines.append(f"| `{name}` | {status} |")

          lines.append("")
          with open(md_path, "w") as f:
              f.write("\n".join(lines))
          print(f"Report written to {md_path}")
          PYEOF

      - name: Commit report
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/stealth-test-latest.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "test: update stealth test report"
            git push
          fi
