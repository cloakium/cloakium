name: Check upstream Chrome Stable (CfT)

on:
  schedule:
    - cron: "23 */3 * * *"
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch latest upstream Stable version (CfT last-known-good)
        id: upstream
        run: |
          set -euo pipefail
          v="$(curl -fsSL \
            "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json" \
            | jq -r '.channels.Stable.version')"
          echo "version=$v" >> "$GITHUB_OUTPUT"
          echo "Upstream Stable: $v"

      - name: Check if release already exists for this version + patches
        id: last
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          v="${{ steps.upstream.outputs.version }}"
          short="$(git rev-parse --short HEAD)"
          # Tag format: {version}+cloakium-{DDHHMM}-{shorthash}
          # Match on version + shorthash only; ignore DDHHMM timestamp.
          pattern="${v}+cloakium-*-${short}"
          echo "Looking for release matching: $pattern"
          match="$(gh release list --repo "$GITHUB_REPOSITORY" --limit 20 \
            --json tagName --jq ".[].tagName" \
            | grep -F "+cloakium-" \
            | while read -r tag; do
                # Strip DDHHMM: extract version and shorthash
                t_ver="${tag%%+*}"
                t_short="${tag##*-}"
                if [ "$t_ver" = "$v" ] && [ "$t_short" = "$short" ]; then
                  echo "$tag"; break
                fi
              done || true)"
          if [ -n "$match" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release already exists: $match"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No release for $v with patches $short"
          fi

      - name: Dispatch build if no release exists
        if: steps.last.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          v="${{ steps.upstream.outputs.version }}"
          echo "No matching release â€” dispatching build for $v"
          gh workflow run build-and-release.yml \
            --repo "$GITHUB_REPOSITORY" \
            -f upstream_version="$v"
